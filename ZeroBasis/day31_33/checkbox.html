<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        input {
            margin-right: 20px;
        }
        th,td {
            text-align: center;
            padding: 5px;
            border: 1px solid red;
        }
        table {
            border-collapse:collapse;
        }
    </style>

</head>
<body>
<div id="region-radio-wrapper"></div>
<div id="product-radio-wrapper"></div>


<table id="table-wrapper">
    <thead>
    <tr id="thead-tr"></tr>
    </thead>

    <tbody></tbody>
</table>

<script>
    let sourceData = [{
        product: "手机",
        region: "华东",
        sale: [120, 100, 140, 160, 180, 185, 190, 210, 230, 245, 255, 270]
    }, {
        product: "手机",
        region: "华北",
        sale: [80, 70, 90, 110, 130, 145, 150, 160, 170, 185, 190, 200]
    }, {
        product: "手机",
        region: "华南",
        sale: [220, 200, 240, 250, 260, 270, 280, 295, 310, 335, 355, 380]
    }, {
        product: "笔记本",
        region: "华东",
        sale: [50, 60, 80, 110, 30, 20, 70, 30, 420, 30, 20, 20]
    }, {
        product: "笔记本",
        region: "华北",
        sale: [30, 35, 50, 70, 20, 15, 30, 50, 710, 130, 20, 20]
    }, {
        product: "笔记本",
        region: "华南",
        sale: [80, 120, 130, 140, 70, 75, 120, 90, 550, 120, 110, 100]
    }, {
        product: "智能音箱",
        region: "华东",
        sale: [10, 30, 4, 5, 6, 5, 4, 5, 6, 5, 5, 25]
    }, {
        product: "智能音箱",
        region: "华北",
        sale: [15, 50, 15, 15, 12, 11, 11, 12, 12, 14, 12, 40]
    }, {
        product: "智能音箱",
        region: "华南",
        sale: [10, 40, 10, 6, 5, 6, 8, 6, 6, 6, 7, 26]
    }];

    //checkbox容器
    var regionWrapper = document.querySelector('#region-radio-wrapper');
    var productWrapper = document.querySelector('#product-radio-wrapper');

    //表格部分
    var trHead = document.querySelector('#thead-tr');
    var tbody = document.querySelector('table tbody');

    //创建checkbox选项
    createCheckbox(regionWrapper, {
        'type': 'region',
        0: '华南',
        1: '华北',
        2: '华东',
    });
    createCheckbox(productWrapper, {
        'type': 'product',
        0: '手机',
        1: '笔记本',
        2: '智能音箱'
    });

    // drawTableHead();//绘制表头
    // drawTable(sourceData);//绘制全部表格

    var regionChilds = document.querySelectorAll('.region');
    var productChilds = document.querySelectorAll('.product');
    var checkAlls = document.querySelectorAll('.all');

    /**
     * 创建checkbox选项
     * @param {object} wrapper - 容器
     * @param {object} childCheck - 各个子选项组成的对象
     */
    function createCheckbox(wrapper, childCheck) {
        var lableAll = document.createElement('lable');
        lableAll.innerText = '全选';
        var checkAll = document.createElement('input');
        checkAll.type = 'checkbox';
        checkAll.value = 'all' + childCheck.type;
        checkAll.className = 'all';
        wrapper.appendChild(lableAll);
        wrapper.appendChild(checkAll);

        for (var index in childCheck) {
            var childLable = document.createElement('lable');
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = childCheck.type;
            checkbox.value = childCheck[index];
            childLable.innerText = childCheck[index];
            if (index === 'type') {
                childLable = null;
                checkbox = null;
                continue;
            }
            wrapper.appendChild(childLable);
            wrapper.appendChild(checkbox);
        }
    }

    addEventListener('change', function (e) {
        var selectRegion = [];
        var selectProduct = [];
        if (e.target.value === 'allregion') {
            var regionSelect = e.target.checked;
            setAllChildState(regionChilds, regionSelect);
        } else if (e.target.value === 'allproduct') {
            var productSelect = e.target.checked;
            setAllChildState(productChilds, productSelect);
        } else if (e.target.className === 'region') {
            isAllSelect(regionChilds, checkAlls[0]);
        } else if (e.target.className === 'product') {
            isAllSelect(productChilds, checkAlls[1]);
        }
        isLastSelect(regionChilds,productChilds, e.target);
        selectProduct = getSelectData(productChilds);
        selectRegion = getSelectData(regionChilds);
        var restrict = [selectRegion, selectProduct];
        var list = filterSelectedData(restrict);
        //绘制表格
        drawTable(list);
    });

    /**
     * 根据全选状态设置所有子选项的状态
     * @param {array} childs - 所有的子选项
     * @param {boolean} select - 所有的子选项的状态
     */
    function setAllChildState(childs, select) {
        for (var i = 0; i < childs.length; i++) {
            childs[i].checked = select;
        }
    }

    /**
     * 判断所有子选项是否已经全部选中并改变全选按钮的状态
     * @param {array} childs - 要判断的子选项数组
     * @param {object} checkAll - 要改变状态的全选按钮
     */
    function isAllSelect(childs, checkAll) {
        for (var i = 0; i < childs.length; i++) {
            if (childs[i].checked === false) {
                checkAll.checked = false;
                return;
            }
        }
        checkAll.checked = true;
    }

    /**
     * 禁止用户取消唯一的选项
     * @param {array} childs - 要判断的子选项数组
     */
    function isLastSelect(childs1,childs2, nowSelect) {
        var childs = [childs1,childs2];
        for (var i = 0; i < childs.length; i++) {
            for(var j = 0; j < childs[i].length; j++) {
                if (childs[i][j].checked === true) {
                    return;
                }
            }
        }
        nowSelect.checked = true;
    }

    //获取用户选择的条件
    function getSelectData(childs) {
        var select = [];
        for (var i = 0; i < childs.length; i++) {
            if (childs[i].checked === true) {
                select.push(childs[i].value);
            }
        }
        return select;
    }


    /**
     * 根据用户的选择从数据源中筛选出合适的数据
     * @param {string} restrict - 用户选择的约束条件
     */
    function filterSelectedData(restrict) {
        var list = [];
        var region = [];
        var regionRestrict = restrict[0];
        var productRestrict = restrict[1];
        region = dataComparison(sourceData, regionRestrict, 'region');
        list = dataComparison(region, productRestrict, 'product');
        if (regionRestrict.length === 0) {
            list = dataComparison(sourceData, productRestrict, 'product');
        }
        if (productRestrict.length === 0) {
            list = dataComparison(sourceData, regionRestrict, 'region');
        }
        return list;
    }

    //对比数据返回符合条件的
    function dataComparison(obj, arr2, type) {
        var data = [];
        for (var i = 0; i < obj.length; i++) {
            for (var j = 0; j < arr2.length; j++) {
                if (obj[i][type] === arr2[j]) {
                    data.push(obj[i]);
                }
            }
        }
        return data;
    }

    function determineFirstColumn() {
        var regionNum = 0;
        var productNum = 0;
        for(var i = 0; i < regionChilds.length; i++) {
            if (regionChilds[i].checked === true){
                regionNum++;
            }
        }
        for(var j = 0; j < productChilds.length; j++) {
            if (productChilds[j].checked === true){
                productNum++;
            }
        }
        if (regionNum === 1 && productNum !== 1) return 'region';
        if (productNum === 1 && regionNum !== 1) return 'product';
        if (productNum === 1 && regionNum === 1) return 'product';
        return "product";
    }

    /**
     * 根据data绘制表格
     * @param {array} list - 要渲染的数据
     */
    function drawTable(list) {
        console.log(list)
        //表格第一列类型
        var firstColumn = determineFirstColumn();

        //绘制thead
        drawTableHead(firstColumn);

        //绘制tbody
        tbody.innerHTML = '';
        //渲染数据
        for (var index in list) {
            var aInfo = [];
            var tr = document.createElement('tr');
            //将产品名称和地区放到info数组中
            if (firstColumn === 'region'){
                aInfo.push(list[index].region);
                aInfo.push(list[index].product);
            } else {
                aInfo.push(list[index].product);
                aInfo.push(list[index].region);
            }

            for (var i = 0,len = list[index]['sale'].length+2; i < len; i++) {
                if (i < 12) {
                    aInfo.push(list[index]['sale'][i])
                }
                var td = document.createElement('td');
                td.innerHTML = aInfo[i];
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
            console.log(aInfo[0]);
        }

    }

    //绘制表头
    function drawTableHead(firstColumn) {

        if (firstColumn === 'region'){
            headData = ['地区','商品', '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'];
        } else {
            headData = ['商品', '地区', '1月', '2月', '3月', '4月', '5月', '6月',
                '7月', '8月', '9月', '10月', '11月', '12月'];
        }
        trHead.innerHTML = '';
        for (var i = 0, len = headData.length; i < len; i++) {
            var th = document.createElement('th');
            th.innerHTML = headData[i];
            trHead.appendChild(th);
        }
    }

</script>
</body>
</html>